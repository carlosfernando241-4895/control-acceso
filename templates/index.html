<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sistema de Control de Acceso</title>

    <!-- Script para validar usuario y permisos -->
    <script>
      window.onload = () => {
        const usuario = JSON.parse(localStorage.getItem("usuario"));
        if (!usuario) {
          window.location.href = "/sesion";
          return;
        }

        // Ocultar secci√≥n usuarios si no tiene permiso
        if (!usuario.permisos.includes("usuarios")) {
          const seccionUsuarios = document.getElementById("seccion-usuarios");
          if (seccionUsuarios) {
            seccionUsuarios.style.display = "none";
          }
        }

        // Mostrar nombre usuario en el header si existe el elemento
        const usuarioNombreElem = document.getElementById("usuario-nombre");
        if (usuarioNombreElem) {
          usuarioNombreElem.innerText = usuario.usuario || usuario.nombre || "Usuario";
        }
      };
    </script>
  <div class="user-header">
      <div class="welcome-message">
        <div class="user-icon">üë§</div>
        <span>Bienvenido, <span class="user-name" id="usuario-nombre">Usuario</span>!</span>
      </div>
      <button class="logout-btn" onclick="cerrarSesion()">
        <span>üîì</span>
        <span>Cerrar Sesi√≥n</span>
      </button>
    </div>
    <link rel="stylesheet" href="{{ url_for('static', filename='style_index.css') }}" />
</head>
<body onload="loadEmployees(); loadVisitors(); loadVehicles(); loadLogs(); updateStats();">

  <!-- Verificar sesi√≥n - si no est√°, redirige -->
  <script>
    const isLoggedIn = sessionStorage.getItem('isLoggedIn');
    if (!isLoggedIn || isLoggedIn !== 'true') {
        window.location.href = '/'; // redirige al login
    }
  </script>

  <div id="main-interface" style="display: none;"></div>

  <div class="container">
    <header>
      Bienvenido, <span id="usuario-nombre"></span>!
    </header>

    <div class="header">
        <h1>üîê Sistema de Control de Acceso</h1>
        <p>Gesti√≥n integral de empleados, visitantes y veh√≠culos</p>
    </div>

    <div class="nav-buttons">
        <button class="nav-btn active" onclick="showSection('employees')">
            üë• Empleados
        </button>
        <button class="nav-btn" onclick="showSection('visitors')">
            üë§ Visitantes
        </button>
        <button class="nav-btn" onclick="showSection('vehicles')">
            üöó Veh√≠culos
        </button>
        <button class="nav-btn" onclick="showSection('access')">
            üîê Control de Acceso
        </button>
        <button class="nav-btn" onclick="showSection('reports')">
            üìä Reportes
        </button>
    </div>

    <!-- ENVOLVEMOS GESTI√ìN DE EMPLEADOS EN SECCI√ìN CON ID PARA CONTROL DE PERMISOS -->

      <!-- Secci√≥n Empleados -->
     <div id="employees" class="section active">
    <h2>üë• Gesti√≥n de Empleados</h2>

    <div class="form-grid">
        <div class="form-group">
            <label for="emp-name">Nombre Completo</label>
            <input type="text" id="emp-name" placeholder="Ej: Juan P√©rez Gonz√°lez" />
        </div>
        <div class="form-group">
            <label for="emp-rut">RUT</label>
            <input type="text" id="emp-rut" placeholder="Ej: 12345678-9" />
        </div>
        <div class="form-group">
            <label for="emp-area">√Årea</label>
            <input type="text" id="emp-area" placeholder="Ej: Sistemas" />
        </div>
        <div class="form-group">
            <label for="emp-company">Empresa</label>
            <input type="text" id="emp-company" placeholder="Ej: TechCorp" />
        </div>
        <div class="form-group">
            <label for="emp-authorized">Autorizado por</label>
            <input type="text" id="emp-authorized" placeholder="Ej: Mar√≠a Garc√≠a" />
        </div>
    </div>

    <button class="btn btn-success" onclick="addEmployee()">‚ûï Agregar Empleado</button>
    <button class="btn" onclick="loadEmployees()">üîÑ Actualizar Lista</button>

    <input
        type="text"
        class="search-box"
        id="employee-search"
        placeholder="üîç Buscar empleado por nombre o RUT..."
        oninput="searchEmployees()"
    />

    <div id="employee-alerts"></div>

    <table class="data-table" id="employees-table">
        <thead>
            <tr>
                <th>Estado</th>
                <th>RUT</th>
                <th>Nombre</th>
                <th>√Årea</th>
                <th>Empresa</th>
                <th>Fecha Ingreso</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="employees-tbody">
            <!-- Empleados se cargar√°n aqu√≠ -->
        </tbody>
    </table>
</div>

    <!-- Secci√≥n Visitantes -->
    <div id="visitors" class="section">
        <h2>üë§ Gesti√≥n de Visitantes</h2>

        <div class="form-grid">
            <div class="form-group">
                <label for="vis-name">Nombre Completo</label>
                <input type="text" id="vis-name" placeholder="Ej: Ana Torres" />
            </div>
            <div class="form-group">
                <label for="vis-rut">RUT</label>
                <input type="text" id="vis-rut" placeholder="Ej: 98765432-1" />
            </div>
            <div class="form-group">
                <label for="vis-company">Empresa/Organizaci√≥n</label>
                <input type="text" id="vis-company" placeholder="Ej: Cliente ABC" />
            </div>
            <div class="form-group">
                <label for="vis-authorized">Autorizado por</label>
                <input type="text" id="vis-authorized" placeholder="Ej: Carlos Mendoza" />
            </div>
            <div class="form-group">
                <label for="vis-date">Fecha de Visita</label>
                <input type="date" id="vis-date" />
            </div>
        </div>

        <button class="btn btn-success" onclick="addVisitor()">‚ûï Agregar Visitante</button>
        <button class="btn" onclick="loadVisitors()">üîÑ Actualizar Lista</button>

        <input
            type="text"
            class="search-box"
            id="visitor-search"
            placeholder="üîç Buscar visitante por nombre o RUT..."
            oninput="searchVisitors()"
        />

        <div id="visitor-alerts"></div>

        <table class="data-table" id="visitors-table">
            <thead>
                <tr>
                    <th>Estado</th>
                    <th>RUT</th>
                    <th>Nombre</th>
                    <th>Empresa</th>
                    <th>Fecha Visita</th>
                    <th>Autorizado por</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="visitors-tbody">
                <!-- Visitantes se cargar√°n aqu√≠ -->
            </tbody>
        </table>
    </div>

    <!-- Secci√≥n Veh√≠culos -->
    <div id="vehicles" class="section">
        <h2>üöó Gesti√≥n de Veh√≠culos</h2>

        <div class="form-grid">
            <div class="form-group">
                <label for="veh-plate">Placa/Patente</label>
                <input type="text" id="veh-plate" placeholder="Ej: ABC12 o ABCD12" />
            </div>
            <div class="form-group">
                <label for="veh-model">Modelo</label>
                <input type="text" id="veh-model" placeholder="Ej: Toyota Corolla 2020" />
            </div>
            <div class="form-group">
                <label for="veh-owner-type">Tipo de Propietario</label>
                <select id="veh-owner-type">
                    <option value="">Seleccionar...</option>
                    <option value="empleado">Empleado</option>
                    <option value="visitante">Visitante</option>
                </select>
            </div>
            <div class="form-group">
                <label for="veh-owner-rut">RUT del Propietario</label>
                <input type="text" id="veh-owner-rut" placeholder="Ej: 12345678-9" />
            </div>
        </div>

        <button class="btn btn-success" onclick="addVehicle()">‚ûï Agregar Veh√≠culo</button>
        <button class="btn" onclick="loadVehicles()">üîÑ Actualizar Lista</button>

        <input
            type="text"
            class="search-box"
            id="vehicle-search"
            placeholder="üîç Buscar veh√≠culo por placa..."
            oninput="searchVehicles()"
        />

        <div id="vehicle-alerts"></div>

        <table class="data-table" id="vehicles-table">
            <thead>
                <tr>
                    <th>Placa</th>
                    <th>Modelo</th>
                    <th>Tipo Propietario</th>
                    <th>RUT Propietario</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="vehicles-tbody">
                <!-- Veh√≠culos se cargar√°n aqu√≠ -->
            </tbody>
        </table>
    </div>

    <!-- Secci√≥n Control de Acceso -->
    <div id="access" class="section">
        <h2>üîê Control de Acceso</h2>

        <div class="form-grid">
            <div class="form-group">
                <label for="access-type">Tipo de Verificaci√≥n</label>
                <select id="access-type" onchange="toggleAccessInput()">
                    <option value="persona">Persona (RUT)</option>
                    <option value="vehiculo">Veh√≠culo (Placa/Patente)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="access-input" id="access-input-label">RUT de la Persona</label>
                <input type="text" id="access-input" placeholder="Ej: 12345678-9" />
            </div>
        </div>

        <button class="btn btn-success" onclick="verifyAccess()">üîç Verificar Acceso</button>

        <div id="access-result"></div>

        <h3>üìã √öltimos Registros de Acceso</h3>
        <div class="logs-container" id="access-logs">
            <!-- Logs se cargar√°n aqu√≠ -->
        </div>
    </div>

    <!-- Secci√≥n Reportes -->
    <div id="reports" class="section">
        <h2>üìä Reportes y Estad√≠sticas</h2>

        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="total-employees">0</h3>
                <p>Empleados Registrados</p>
            </div>
            <div class="stat-card">
                <h3 id="total-visitors">0</h3>
                <p>Visitantes Registrados</p>
            </div>
            <div class="stat-card">
                <h3 id="total-vehicles">0</h3>
                <p>Veh√≠culos Registrados</p>
            </div>
            <div class="stat-card">
                <h3 id="total-logs">0</h3>
                <p>Registros de Acceso</p>
            </div>
            <div class="stat-card">
                <h3 id="today-access">0</h3>
                <p>Accesos Hoy</p>
            </div>
            <div class="stat-card">
                <h3 id="today-denegados">0</h3>
                <p>Accesos Denegados Hoy</p>
            </div>
        </div>

        <button class="btn" onclick="updateStats()">üîÑ Actualizar Estad√≠sticas</button>
        <button class="btn btn-warning" onclick="exportarDatos()">üì• Exportar Datos</button>
    </div>
  </div>

  <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>